/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–¥–∞—á–∏ –∂–∞–ª–æ–± (complaints-page.html)
 * –†–∞–±–æ—Ç–∞–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
 */

document.addEventListener("DOMContentLoaded", async () => {
  console.log("üöÄ Complaints page loaded");

  // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  const btnClosePage = document.getElementById("btn-close-page");
  const storeSelect = document.getElementById("store-select");
  const btnStartComplaints = document.getElementById("btn-start-complaints");
  const btnStopComplaints = document.getElementById("btn-stop-complaints");
  const btnDownloadResults = document.getElementById("btn-download-results");
  const btnNewComplaints = document.getElementById("btn-new-complaints");

  const apiStatsPreview = document.getElementById("api-stats-preview");
  const apiStatsContent = document.getElementById("api-stats-content");
  const btnConfirmStart = document.getElementById("btn-confirm-start");
  const btnCancelPreview = document.getElementById("btn-cancel-preview");

  const complaintsProgress = document.getElementById("complaints-progress");
  const complaintsResults = document.getElementById("complaints-results");
  const logsContainer = document.getElementById("logs-container");

  let isProcessing = false;
  let currentData = null;
  let previewData = null; // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  let currentBatch = 0; // –¢–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä –ø–∞–∫–µ—Ç–∞ (–¥–ª—è skip)
  let totalProcessedGlobal = 0; // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∂–∞–ª–æ–± –∑–∞ –≤—Å—é —Å–µ—Å—Å–∏—é
  let totalSentGlobal = 0; // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∂–∞–ª–æ–± –∑–∞ –≤—Å—é —Å–µ—Å—Å–∏—é
  let consecutiveEmptyBatches = 0; // –°—á–µ—Ç—á–∏–∫ –ø—É—Å—Ç—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –ø–æ–¥—Ä—è–¥
  const MAX_EMPTY_BATCHES = 5; // –ú–∞–∫—Å–∏–º—É–º –ø—É—Å—Ç—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –ø–æ–¥—Ä—è–¥ –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
  const BATCH_SIZE = 200; // üîß –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ (200 –¥–ª—è –Ω–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞)
  let batchesHistory = []; // üìä –ò—Å—Ç–æ—Ä–∏—è –±–∞—Ç—á–µ–π

  // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  btnClosePage.addEventListener("click", () => {
    window.close();
  });

  // –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–µ—Å–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã)
  const DEFAULT_PILOT_TOKEN = "wbrm_u1512gxsgp1nt1n31fmsj1d31o51jue";
  const DEFAULT_PILOT_ENDPOINT = "https://pilot-entry.ru/api";

  // üîí –•–ê–†–î–ö–û–î Backend API –¥–ª—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–í–†–ï–ú–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï)
  const BACKEND_ENDPOINT = 'http://158.160.217.236';
  const BACKEND_TOKEN = 'wbrm_0ab7137430d4fb62948db3a7d9b4b997'; // ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –æ—Ç 2026-01-29

  // ========================================================================
  // –§–£–ù–ö–¶–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø (–û–ü–†–ï–î–ï–õ–ï–ù–ê –†–ê–ù–û –î–õ–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –í –ê–í–¢–û–ò–ù–ñ–ï–ö–¢–ï)
  // ========================================================================

  /**
   * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞ –≤ UI
   * @param {string} level - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∞: "info", "success", "warn", "error"
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
   */
  function addLog(level, message) {
    const logDiv = document.createElement("div");
    logDiv.className = `log-entry log-${level}`;

    const time = new Date().toLocaleTimeString('ru-RU');
    logDiv.innerHTML = `<span class="log-timestamp">${time}</span>${message}`;

    logsContainer.appendChild(logDiv);
    logsContainer.scrollTop = logsContainer.scrollHeight;
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ Backend API)
  async function loadStores(forceRefresh = false) {
    try {
      console.log("üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –º–∞–≥–∞–∑–∏–Ω–æ–≤...");

      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
      const errorElement = document.getElementById('store-load-error');
      if (errorElement) {
        errorElement.style.display = 'none';
        errorElement.textContent = '';
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ó–∞–≥—Ä—É–∑–∫–∞..."
      storeSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤...</option>';
      storeSelect.disabled = true;

      // üîí –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–í–†–ï–ú–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï –¥–ª—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
      const backendEndpoint = BACKEND_ENDPOINT;
      const backendToken = BACKEND_TOKEN;

      console.log("üåê –ó–∞–ø—Ä–æ—Å –º–∞–≥–∞–∑–∏–Ω–æ–≤:", `${backendEndpoint}/api/extension/stores`);
      console.log("üîë –¢–æ–∫–µ–Ω –¥–ª–∏–Ω–∞:", backendToken.length);

      // –ó–∞–ø—Ä–æ—Å –∫ –Ω–æ–≤–æ–º—É endpoint
      const response = await fetch(`${backendEndpoint}/api/extension/stores`, {
        headers: {
          'Authorization': `Bearer ${backendToken}`,
          'Content-Type': 'application/json'
        }
      });

      console.log("üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", response.status, response.statusText);

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      if (!response.ok) {
        let errorMessage = `HTTP ${response.status}`;

        if (response.status === 401) {
          errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π Backend Token. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
        } else if (response.status === 429) {
          const resetAt = response.headers.get('X-RateLimit-Reset');
          const resetTime = resetAt ? new Date(resetAt).toLocaleTimeString('ru-RU') : '—á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É';
          errorMessage = `Rate limit –ø—Ä–µ–≤—ã—à–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤ ${resetTime}`;
        } else {
          const errorText = await response.text();
          console.error("‚ùå –û—à–∏–±–∫–∞ HTTP:", response.status, errorText);
          errorMessage = `HTTP ${response.status}: ${errorText}`;
        }

        throw new Error(errorMessage);
      }

      // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
      const stores = await response.json();
      console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤: ${stores.length}`, stores);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limit headers
      const rateLimitRemaining = response.headers.get('X-RateLimit-Remaining');
      const rateLimitLimit = response.headers.get('X-RateLimit-Limit');
      if (rateLimitRemaining && rateLimitLimit) {
        console.log(`[Complaints Page] Rate limit: ${rateLimitRemaining}/${rateLimitLimit}`);
        if (parseInt(rateLimitRemaining) < 10) {
          console.warn(`[Complaints Page] ‚ö†Ô∏è Rate limit warning: –æ—Å—Ç–∞–ª–æ—Å—å ${rateLimitRemaining} –∑–∞–ø—Ä–æ—Å–æ–≤`);
        }
      }

      // –ó–∞–ø–æ–ª–Ω—è–µ–º dropdown
      storeSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>';

      if (stores.length === 0) {
        storeSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤</option>';
        storeSelect.disabled = true;
        addLog("warn", "‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤");
        return;
      }

      stores.forEach((store) => {
        const option = document.createElement('option');
        option.value = store.id; // Store ID –¥–ª—è API
        option.textContent = store.name; // –ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è UI

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
        if (!store.isActive) {
          option.disabled = true;
          option.textContent += ' (–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω)';
          option.style.color = '#999';
        }

        storeSelect.appendChild(option);
      });

      // –í–∫–ª—é—á–∞–µ–º dropdown
      storeSelect.disabled = false;

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±–æ—Ä (–µ—Å–ª–∏ –±—ã–ª)
      const lastSelectedStoreId = await chrome.storage.local.get('currentStoreId');
      if (lastSelectedStoreId.currentStoreId) {
        storeSelect.value = lastSelectedStoreId.currentStoreId;
        console.log(`[Complaints Page] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—ã–±–æ—Ä: ${lastSelectedStoreId.currentStoreId}`);
        addLog("info", `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${stores.length} –º–∞–≥–∞–∑–∏–Ω–æ–≤ (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—ã–±–æ—Ä)`);
      } else if (stores.length === 1 && stores[0].isActive) {
        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        storeSelect.value = stores[0].id;
        await chrome.storage.local.set({ currentStoreId: stores[0].id });
        console.log(`[Complaints Page] –ê–≤—Ç–æ–≤—ã–±–æ—Ä –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞: ${stores[0].name}`);
        addLog("success", `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${stores.length} –º–∞–≥–∞–∑–∏–Ω–æ–≤ (–∞–≤—Ç–æ–≤—ã–±–æ—Ä: ${stores[0].name})`);
      } else {
        addLog("info", `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${stores.length} –º–∞–≥–∞–∑–∏–Ω–æ–≤`);
      }

    } catch (err) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤:", err);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ UI
      const errorElement = document.getElementById('store-load-error');
      if (errorElement) {
        errorElement.textContent = `‚ùå ${err.message}`;
        errorElement.style.display = 'block';
      }

      // Dropdown —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ
      storeSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤</option>';
      storeSelect.disabled = true;

      // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      if (err.message.includes('Backend Token')) {
        storeSelect.innerHTML = '<option value="">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Backend Token</option>';
      }

      addLog("error", `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤: ${err.message}`);
    }
  }

  await loadStores();

  // ========================================================================
  // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –ò–ù–ñ–ï–ö–¢ –°–ö–†–ò–ü–¢–û–í –ü–†–ò –û–¢–ö–†–´–¢–ò–ò –°–¢–†–ê–ù–ò–¶–´
  // ========================================================================

  /**
   * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É WB –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ complaints-page
   * –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –ë–ï–ó –∑–∞–ø—É—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–∞–ª–æ–±
   */
  setTimeout(async () => {
    try {
      addLog("info", "üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –≤–∫–ª–∞–¥–∫–∏ WB –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤...");

      const allTabs = await chrome.tabs.query({});
      const wbTab = allTabs.find(tab =>
        tab.url?.includes("seller.wildberries.ru") &&
        tab.url?.includes("/feedbacks")
      );

      if (wbTab) {
        addLog("success", `‚úÖ –ù–∞–π–¥–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ WB: ${wbTab.title}`);
        addLog("info", `üìç URL: ${wbTab.url}`);

        // –ò–Ω–∂–µ–∫—Ç–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        const scriptsLoaded = await ensureScriptsLoaded(wbTab);

        if (scriptsLoaded) {
          addLog("success", "‚úÖ –°–∫—Ä–∏–ø—Ç—ã –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω—ã! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –≤ –∫–æ–Ω—Å–æ–ª–∏ WB.");
          addLog("info", "üí° –û—Ç–∫—Ä–æ–π—Ç–µ DevTools –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ WB –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ window.DataExtractor");
        } else {
          addLog("warn", "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É WB.");
        }
      } else {
        addLog("warn", "‚ö†Ô∏è –í–∫–ª–∞–¥–∫–∞ WB —Å feedbacks –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
        addLog("info", "üí° –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É seller.wildberries.ru/feedbacks –¥–ª—è –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤");
      }
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∏–Ω–∂–µ–∫—Ç–∞:", error);
      addLog("error", `‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∏–Ω–∂–µ–∫—Ç–∞: ${error.message}`);
    }
  }, 1000); // –î–∞–µ–º 1 —Å–µ–∫—É–Ω–¥—É –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –º–∞–≥–∞–∑–∏–Ω–æ–≤

  // ========================================================================
  // EVENT LISTENERS –î–õ–Ø MULTI-STORE SUPPORT
  // ========================================================================

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –º–∞–≥–∞–∑–∏–Ω–∞
   * –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞
   */
  storeSelect.addEventListener('change', async (event) => {
    const selectedStoreId = event.target.value;

    if (!selectedStoreId) {
      console.log('[Complaints Page] No store selected');
      return;
    }

    try {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –≤ chrome.storage.local
      await chrome.storage.local.set({ currentStoreId: selectedStoreId });

      // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
      const selectedOption = storeSelect.options[storeSelect.selectedIndex];
      const storeName = selectedOption ? selectedOption.textContent : selectedStoreId;

      console.log(`[Complaints Page] Selected store: ${storeName} (${selectedStoreId})`);
      addLog("info", `‚úÖ –í—ã–±—Ä–∞–Ω –º–∞–≥–∞–∑–∏–Ω: ${storeName}`);

    } catch (error) {
      console.error('[Complaints Page] Failed to save store selection:', error);
      addLog("error", `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞: ${error.message}`);
    }
  });

  /**
   * –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤
   * –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–µ—à (–µ—Å–ª–∏ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ Phase 3)
   */
  const refreshStoresBtn = document.getElementById('refresh-stores-btn');
  if (refreshStoresBtn) {
    refreshStoresBtn.addEventListener('click', async () => {
      console.log('[Complaints Page] Manual refresh triggered');

      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
      refreshStoresBtn.disabled = true;
      refreshStoresBtn.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';

      try {
        await loadStores(true); // forceRefresh = true
        refreshStoresBtn.textContent = '‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ';
        setTimeout(() => {
          refreshStoresBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
          refreshStoresBtn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('[Complaints Page] Refresh failed:', error);
        refreshStoresBtn.textContent = '‚ùå –û—à–∏–±–∫–∞';
        setTimeout(() => {
          refreshStoresBtn.textContent = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
          refreshStoresBtn.disabled = false;
        }, 2000);
      }
    });
  }

  // ========================================================================
  // –¶–ï–ù–¢–†–ê–õ–ò–ó–û–í–ê–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ò–ù–ñ–ï–ö–¢–ê –°–ö–†–ò–ü–¢–û–í
  // ========================================================================

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å content script —á–µ—Ä–µ–∑ ping
   * @param {number} tabId - ID –≤–∫–ª–∞–¥–∫–∏
   * @param {number} maxRetries - –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫
   * @returns {Promise<boolean>} - true –µ—Å–ª–∏ –≥–æ—Ç–æ–≤
   */
  async function pingContentScript(tabId, maxRetries = 3) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        await chrome.tabs.sendMessage(tabId, { type: "ping" });
        addLog("success", `‚úÖ Content script –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ (–ø–æ–ø—ã—Ç–∫–∞ ${attempt}/${maxRetries})`);
        return true;
      } catch (error) {
        if (attempt < maxRetries) {
          addLog("info", `‚è≥ Content script –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥–µ–º... (–ø–æ–ø—ã—Ç–∫–∞ ${attempt}/${maxRetries})`);
          await new Promise(resolve => setTimeout(resolve, 500));
        } else {
          addLog("error", `‚ùå Content script –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ ${maxRetries} –ø–æ–ø—ã—Ç–æ–∫`);
          return false;
        }
      }
    }
    return false;
  }

  /**
   * –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–∞ –≤–∫–ª–∞–¥–∫—É WB
   * @param {Object} wbTab - –û–±—ä–µ–∫—Ç –≤–∫–ª–∞–¥–∫–∏ Chrome
   * @returns {Promise<boolean>} - true –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
   */
  async function ensureScriptsLoaded(wbTab) {
    try {
      addLog("info", `üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ #${wbTab.id}`);
      addLog("info", `üìç –ù–∞–∑–≤–∞–Ω–∏–µ: ${wbTab.title}`);
      addLog("info", `üìç URL: ${wbTab.url}`);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ª–∏ —É–∂–µ —Å–∫—Ä–∏–ø—Ç—ã
      let scriptsLoaded = false;
      try {
        const [{ result }] = await chrome.scripting.executeScript({
          target: { tabId: wbTab.id },
          func: () => {
            return !!(window.WBUtils && window.hasListenerAdded);
          }
        });
        scriptsLoaded = result;
        addLog("info", `‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: scriptsLoaded = ${scriptsLoaded}`);
      } catch (error) {
        addLog("warn", `‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤: ${error.message}`);
        scriptsLoaded = false;
      }

      // –ò–Ω–∂–µ–∫—Ç–∏–º —Å–∫—Ä–∏–ø—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
      if (!scriptsLoaded) {
        addLog("info", "üì• –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∂–µ–∫—Ç —Å–∫—Ä–∏–ø—Ç–æ–≤...");

        try {
          await chrome.scripting.executeScript({
            target: { tabId: wbTab.id },
            files: [
              // 1. –£—Ç–∏–ª–∏—Ç—ã (–¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–µ—Ä–≤—ã–º–∏)
              "src/utils/logger-content.js",
              "src/contents/complaints/utils.js",

              // 2. DOM –º–æ–¥—É–ª–∏ (—Ä–∞–±–æ—Ç–∞ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏)
              "src/contents/complaints/dom/data-extractor.js",
              "src/contents/complaints/dom/element-finder.js",

              // 3. –°–µ—Ä–≤–∏—Å—ã (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
              "src/contents/complaints/services/search-service.js",
              "src/contents/complaints/services/navigation-service.js",
              "src/contents/complaints/services/progress-service.js",
              "src/contents/complaints/services/complaint-service.js",

              // 4. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã)
              "src/contents/complaints/handlers/optimized-handler.js",

              // 5. Entry point (–¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º)
              "src/contents/complaints/content.js"
            ],
          });
          addLog("success", "‚úÖ –°–∫—Ä–∏–ø—Ç—ã —É—Å–ø–µ—à–Ω–æ –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã (v1.3.0, –º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)");
        } catch (error) {
          addLog("error", `‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∂–µ–∫—Ç–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤: ${error.message}`);
          throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã: ${error.message}`);
        }

        // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é content scripts
        addLog("info", "‚è≥ –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ content scripts (500ms)...");
        await new Promise(resolve => setTimeout(resolve, 500));

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ content script –≥–æ—Ç–æ–≤
        const isReady = await pingContentScript(wbTab.id, 3);
        if (!isReady) {
          throw new Error("Content script –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ –∏–Ω–∂–µ–∫—Ç–∞");
        }
      } else {
        addLog("info", "‚ÑπÔ∏è –°–∫—Ä–∏–ø—Ç—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–∂–µ–∫—Ç");

        // –í—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
        const isReady = await pingContentScript(wbTab.id, 1);
        if (!isReady) {
          addLog("warn", "‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞—é—Ç. –ü–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∏–Ω–∂–µ–∫—Ç–∏—Ç—å...");
          scriptsLoaded = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –ø–µ—Ä–µ–∏–Ω–∂–µ–∫—Ç–∞
          return await ensureScriptsLoaded(wbTab); // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤
        }
      }

      return true;
    } catch (error) {
      addLog("error", `‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤: ${error.message}`);
      return false;
    }
  }

  // –ü–∞—Ä—Å–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has("storeId")) {
    storeSelect.value = urlParams.get("storeId");
  }
  if (urlParams.has("stars")) {
    const stars = urlParams.get("stars").split(",");
    stars.forEach((star) => {
      const checkbox = document.querySelector(`.complaint-star[value="${star}"]`);
      if (checkbox) checkbox.checked = true;
    });
  }
  if (urlParams.has("articles")) {
    document.getElementById("complaint-articles").value = decodeURIComponent(urlParams.get("articles"));
  }

  // –ù–∞—á–∞—Ç—å –ø–æ–¥–∞—á—É –∂–∞–ª–æ–±
  btnStartComplaints.addEventListener("click", async () => {
    const selectedStore = storeSelect.value;
    if (!selectedStore) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω!");
      return;
    }

    const checkedStars = Array.from(
      document.querySelectorAll('.complaint-star:checked')
    ).map((checkbox) => Number(checkbox.value));

    if (checkedStars.length === 0) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –æ—Ü–µ–Ω–∫—É –∑–≤–µ–∑–¥!");
      return;
    }

    // –ü–∞—Ä—Å–∏–º –∞—Ä—Ç–∏–∫—É–ª—ã –∏–∑ textarea
    const articlesText = document.getElementById("complaint-articles").value.trim();
    const articlesArray = articlesText.length > 0
      ? articlesText.split(/[\s,\n]+/).map(a => a.trim()).filter(a => a.length > 0)
      : [];

    const isFilterByArticles = articlesArray.length > 0;

    try {
      if (isFilterByArticles) {
        addLog("info", `üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–¥–∞—á–∏ –∂–∞–ª–æ–± –¥–ª—è ${articlesArray.length} –∞—Ä—Ç–∏–∫—É–ª–æ–≤...`);
        addLog("info", `üì¶ –ê—Ä—Ç–∏–∫—É–ª—ã: ${articlesArray.join(", ")}`);
      } else {
        addLog("info", "üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–¥–∞—á–∏ –∂–∞–ª–æ–± –Ω–∞ –í–°–ï –æ—Ç–∑—ã–≤—ã –∏–∑ API...");
        addLog("warn", "‚ö†Ô∏è –ê—Ä—Ç–∏–∫—É–ª—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã - –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤—Å–µ –∂–∞–ª–æ–±—ã –∏–∑ API!");
      }

      // –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∂–∞–ª–æ–±—ã –∏–∑ API
      const result = await chrome.storage.sync.get("settings");
      let settings = result.settings;

      // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      if (!settings) {
        settings = {
          pilotToken: DEFAULT_PILOT_TOKEN,
          pilotEndpoint: DEFAULT_PILOT_ENDPOINT
        };
      }

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
      const pilotToken = settings.pilotToken || DEFAULT_PILOT_TOKEN;
      const endpoint = settings.pilotEndpoint || DEFAULT_PILOT_ENDPOINT;
      addLog("info", "üì° –ó–∞–≥—Ä—É–∂–∞–µ–º –∂–∞–ª–æ–±—ã –∏–∑ API...");

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º background script –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
      const apiResponse = await chrome.runtime.sendMessage({
        type: "getComplaints",
        storeId: selectedStore,
        skip: 0,
        take: BATCH_SIZE, // üîß –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞
      });

      console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:", apiResponse);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏
      if (apiResponse.error) {
        alert(`‚ùå –û—à–∏–±–∫–∞ API: ${apiResponse.error}`);
        addLog("error", `‚ùå –û—à–∏–±–∫–∞ API: ${apiResponse.error}`);
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
      if (!apiResponse.data || !Array.isArray(apiResponse.data)) {
        alert(`‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç API`);
        addLog("error", `‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö`);
        return;
      }

      const allComplaints = apiResponse.data;
      console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allComplaints.length} –∂–∞–ª–æ–±`);

      // üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç productId –∏–∑ Backend
      console.log('\n=== üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê productId ===');
      const productIdSamples = allComplaints.slice(0, 5).map(c => ({
        id: c.id,
        productId: c.productId,
        isNumeric: /^\d+$/.test(c.productId),
        type: typeof c.productId,
        rating: c.rating
      }));
      console.table(productIdSamples);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ productId
      const numericCount = allComplaints.filter(c => /^\d+$/.test(c.productId)).length;
      const nonNumericCount = allComplaints.length - numericCount;

      console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ productId:`);
      console.log(`  ‚úÖ –ß–∏—Å–ª–æ–≤—ã—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç): ${numericCount}`);
      console.log(`  ‚ùå –ù–ï—á–∏—Å–ª–æ–≤—ã—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç): ${nonNumericCount}`);

      if (nonNumericCount > 0) {
        console.error('\n‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è');
        console.error('Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ù–ï –∞—Ä—Ç–∏–∫—É–ª—ã WB (—Ü–∏—Ñ—Ä—ã), –∞ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ (–±—É–∫–≤—ã)!');
        console.error('–≠—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ü–û–õ–ù–û–ú–£ –û–¢–ö–ê–ó–£ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:');
        console.error('  1. –ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç (WB –Ω–µ –Ω–∞–π–¥–µ—Ç —Ç–æ–≤–∞—Ä)');
        console.error('  2. –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç (–∫–ª—é—á–∏ –Ω–µ —Å–æ–≤–ø–∞–¥—É—Ç)');
        console.error('  3. –ñ–∞–ª–æ–±—ã –ù–ï –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã ‚ùå');
        console.error('\n–ü—Ä–∏–º–µ—Ä—ã –Ω–µ—á–∏—Å–ª–æ–≤—ã—Ö productId:');
        allComplaints
          .filter(c => !/^\d+$/.test(c.productId))
          .slice(0, 10)
          .forEach(c => console.error(`  - "${c.productId}" (ID: ${c.id})`));
        console.error('\n‚ö†Ô∏è –ù–ï–û–ë–•–û–î–ò–ú–û –ò–°–ü–†–ê–í–ò–¢–¨ BACKEND API!');
        console.error('‚ö†Ô∏è –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: docs/TESTING_PLAN.md');
      }
      console.log('=== –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===\n');

      addLog("success", `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allComplaints.length} –∂–∞–ª–æ–± –∏–∑ API`);

      if (nonNumericCount > 0) {
        addLog("error", `‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ${nonNumericCount} –Ω–µ—á–∏—Å–ª–æ–≤—ã—Ö productId!`);
        addLog("error", `‚ùå –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ù–ï –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å! –°–º. –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`);
      }

      // ========== –§–ò–õ–¨–¢–† –ü–û –î–õ–ò–ù–ï –¢–ï–ö–°–¢–ê ==========
      const MAX_TEXT_LENGTH = 1000;
      const PREFIX_LENGTH = 20; // "–ñ–∞–ª–æ–±–∞ –æ—Ç: DD.MM\n\n"
      const MAX_COMPLAINT_TEXT = MAX_TEXT_LENGTH - PREFIX_LENGTH; // 980

      const filterResults = {
        total: allComplaints.length,
        valid: 0,
        tooLong: 0,
        parseError: 0,
        longTexts: []
      };

      const allComplaintsFiltered = allComplaints.filter(complaint => {
        try {
          // ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ Backend API v2.0
          // Backend —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç complaintText –∫–∞–∫ –æ–±—ä–µ–∫—Ç, –∞ –Ω–µ JSON-—Å—Ç—Ä–æ–∫—É
          let parsed;
          if (typeof complaint.complaintText === 'object' && complaint.complaintText !== null) {
            parsed = complaint.complaintText; // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç - —É–∂–µ –æ–±—ä–µ–∫—Ç
          } else {
            // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - –ø–∞—Ä—Å–∏–º –∏–∑ markdown-–æ–±—ë—Ä–Ω—É—Ç–æ–π JSON-—Å—Ç—Ä–æ–∫–∏
            const rawJson = complaint.complaintText.replace(/```json|```/g, "").trim();
            parsed = JSON.parse(rawJson);
          }
          const textLength = (parsed.complaintText || "").length;

          if (textLength > MAX_COMPLAINT_TEXT) {
            filterResults.tooLong++;
            filterResults.longTexts.push({
              productId: complaint.productId,
              id: complaint.id,
              length: textLength
            });
            return false;
          }

          filterResults.valid++;
          return true;
        } catch (err) {
          filterResults.parseError++;
          return false;
        }
      });

      // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      addLog("info", `üìè –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–ª–∏–Ω–µ —Ç–µ–∫—Å—Ç–∞ (–º–∞–∫—Å ${MAX_COMPLAINT_TEXT} —Å–∏–º–≤–æ–ª–æ–≤):`);
      addLog("info", `  ‚úÖ –í–∞–ª–∏–¥–Ω—ã—Ö: ${filterResults.valid}`);
      if (filterResults.tooLong > 0) {
        addLog("warn", `  ‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã—Ö (>${MAX_COMPLAINT_TEXT} —Å–∏–º–≤–æ–ª–æ–≤): ${filterResults.tooLong}`);
        const top5 = filterResults.longTexts.sort((a, b) => b.length - a.length).slice(0, 5);
        top5.forEach(item => {
          addLog("warn", `    üì¶ –ê—Ä—Ç ${item.productId}, ID ${item.id}: ${item.length} —Å–∏–º–≤–æ–ª–æ–≤`);
        });
      }
      if (filterResults.parseError > 0) {
        addLog("error", `  ‚ùå –û—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${filterResults.parseError}`);
      }

      // –®–∞–≥ 2: –§–∏–ª—å—Ç—Ä—É–µ–º –∂–∞–ª–æ–±—ã –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)
      let filteredComplaints;
      let articleStats = {};

      if (isFilterByArticles) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∞—Ä—Ç–∏–∫—É–ª–∞–º
        filteredComplaints = allComplaintsFiltered.filter(complaint =>
          articlesArray.includes(complaint.productId)
        );

        addLog("info", `üîç –ù–∞–π–¥–µ–Ω–æ ${filteredComplaints.length} –∂–∞–ª–æ–± –Ω–∞ ${articlesArray.length} –∞—Ä—Ç–∏–∫—É–ª–æ–≤`);

        if (filteredComplaints.length === 0) {
          alert("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∂–∞–ª–æ–± –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤!");
          addLog("warn", "‚ö†Ô∏è –ù–µ—Ç –∂–∞–ª–æ–± –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏");
          return;
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º
        articlesArray.forEach(article => {
          articleStats[article] = filteredComplaints.filter(c => c.productId === article).length;
        });

        addLog("info", "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º:");
        Object.entries(articleStats).forEach(([article, count]) => {
          addLog("info", `  üì¶ ${article}: ${count} –∂–∞–ª–æ–±`);
        });
      } else {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –í–°–ï –∂–∞–ª–æ–±—ã –∏–∑ API
        filteredComplaints = allComplaintsFiltered;

        if (filteredComplaints.length === 0) {
          alert("‚ùå –í API –Ω–µ—Ç –∂–∞–ª–æ–± –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏!");
          addLog("warn", "‚ö†Ô∏è –ù–µ—Ç –∂–∞–ª–æ–± –≤ API");
          return;
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –∞—Ä—Ç–∏–∫—É–ª–∞–º –∏–∑ API
        filteredComplaints.forEach(complaint => {
          const articleId = complaint.productId;
          if (!articleStats[articleId]) {
            articleStats[articleId] = 0;
          }
          articleStats[articleId]++;
        });

        addLog("success", `‚úÖ –ë—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${filteredComplaints.length} –∂–∞–ª–æ–± –Ω–∞ ${Object.keys(articleStats).length} –∞—Ä—Ç–∏–∫—É–ª–æ–≤`);
        addLog("info", "üìä –¢–æ–ø-5 –∞—Ä—Ç–∏–∫—É–ª–æ–≤:");
        Object.entries(articleStats)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
          .forEach(([article, count]) => {
            addLog("info", `  üì¶ ${article}: ${count} –∂–∞–ª–æ–±`);
          });
      }

      // –®–∞–≥ 3: –ò—â–µ–º –≤–∫–ª–∞–¥–∫—É WB –¥–ª—è –ø–æ–¥–∞—á–∏ –∂–∞–ª–æ–±
      addLog("info", "üîç –ò—â–µ–º –æ—Ç–∫—Ä—ã—Ç—É—é –≤–∫–ª–∞–¥–∫—É Wildberries...");
      const allTabs = await chrome.tabs.query({});

      // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
      addLog("info", `üìã –í—Å–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–∫–ª–∞–¥–æ–∫: ${allTabs.length}`);
      const wbTabs = allTabs.filter(tab => tab.url && tab.url.includes("seller.wildberries.ru"));
      if (wbTabs.length > 0) {
        addLog("info", `üìã –ù–∞–π–¥–µ–Ω–æ ${wbTabs.length} –≤–∫–ª–∞–¥–æ–∫ WB Seller:`);
        wbTabs.forEach(tab => {
          addLog("info", `  ‚Ä¢ #${tab.id}: ${tab.title} (${tab.url})`);
        });
      }

      // –ò—â–µ–º –≤–∫–ª–∞–¥–∫—É —Å feedbacks
      const wbTab = allTabs.find(tab =>
        tab.url &&
        tab.url.includes("seller.wildberries.ru") &&
        tab.url.includes("/feedbacks")
      );

      if (!wbTab) {
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤–∫–ª–∞–¥–∫—É —Å feedbacks, –Ω–æ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏ WB
        const anyWbTab = allTabs.find(tab =>
          tab.url && tab.url.includes("seller.wildberries.ru")
        );

        if (anyWbTab) {
          alert("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∑—ã–≤–æ–≤ Wildberries.\n\n–ù–∞–π–¥–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ WB, –Ω–æ —ç—Ç–æ –Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ /feedbacks.\n–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É '–û—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π' –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
          addLog("error", `‚ùå –í–∫–ª–∞–¥–∫–∞ WB –Ω–∞–π–¥–µ–Ω–∞ (#${anyWbTab.id}), –Ω–æ —ç—Ç–æ –Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ feedbacks`);
          addLog("error", `üìç URL: ${anyWbTab.url}`);
        } else {
          alert("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Wildberries.\n\n–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É '–û—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π' (seller.wildberries.ru/feedbacks) –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
          addLog("error", "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∏ –æ–¥–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ —Å WB Seller");
        }
        return;
      }

      addLog("success", `‚úÖ –ù–∞–π–¥–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ WB: ${wbTab.title}`);
      addLog("info", `üìç –í–∫–ª–∞–¥–∫–∞ #${wbTab.id}: ${wbTab.url}`);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      previewData = {
        filteredComplaints,
        articleStats,
        allComplaints: allComplaintsFiltered, // –£–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –¥–ª–∏–Ω–µ
        isFilterByArticles,
        checkedStars,
        articlesArray,
        selectedStore,
        wbTab
      };

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º
      showPreviewStats(filteredComplaints, articleStats, isFilterByArticles, checkedStars);

      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º preview
      btnStartComplaints.classList.add("hidden");
      apiStatsPreview.classList.remove("hidden");

    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:", error);
      alert("‚ùå –û—à–∏–±–∫–∞: " + error.message);
      addLog("error", `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    }
  });

  // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–¥–∞—á—É –∂–∞–ª–æ–±
  btnStopComplaints.addEventListener("click", async () => {
    isProcessing = false;
    addLog("warn", "‚èπÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º");

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ Google Sheets –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ totalProcessedGlobal == 0 (—á—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–∫—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
    const totalSkipped = batchesHistory.reduce((sum, b) => sum + b.skipped, 0);
    const totalErrors = batchesHistory.reduce((sum, b) => sum + b.errors, 0);

    const sheetsResult = await sendBatchToSheets(currentBatch, {
      processed: totalProcessedGlobal,
      sent: totalSentGlobal,
      skipped: totalSkipped,
      errors: totalErrors,
      duration: 0,
      startTime: new Date().toISOString()
    }, "stopped");

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Sheets
    if (sheetsResult.success) {
      addLog("info", "üìä –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Google Sheets (–æ—Å—Ç–∞–Ω–æ–≤–∫–∞)");
    } else if (sheetsResult.disabled) {
      addLog("info", "‚ÑπÔ∏è Google Sheets –æ—Ç–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö");
    }
    // –û—à–∏–±–∫–∏ —É–∂–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ sendBatchToSheets

    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const progressTitle = document.getElementById("progress-title");
    if (progressTitle) {
      progressTitle.textContent = "‚è∏Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
      progressTitle.style.color = "#f59e0b"; // –û—Ä–∞–Ω–∂–µ–≤—ã–π —Ü–≤–µ—Ç
    }

    // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –Ω–∞ "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—á–∞–ª—É"
    btnStopComplaints.textContent = "üîÑ –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—á–∞–ª—É";
    btnStopComplaints.onclick = () => {
      // –°–±—Ä–æ—Å –∫ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      complaintsProgress.classList.add("hidden");
      btnStartComplaints.classList.remove("hidden");

      // –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      document.getElementById("c-progress-processed").textContent = "0";
      document.getElementById("c-progress-sent").textContent = "0";
      document.getElementById("c-progress-skipped").textContent = "0";
      document.getElementById("c-progress-errors").textContent = "0";
      document.getElementById("c-progress-fill").style.width = "0%";
      document.getElementById("c-progress-start-time").textContent = "-";

      // –û—á–∏—Å—Ç–∫–∞ –±–∞—Ç—á–µ–π
      currentBatch = 0;
      totalProcessedGlobal = 0;
      totalSentGlobal = 0;
      batchesHistory = [];
      updateBatchesDisplay();
      updateTotalStats();

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫—É
      if (progressTitle) {
        progressTitle.textContent = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–∞–ª–æ–±...";
        progressTitle.style.color = "";
      }
      btnStopComplaints.textContent = "‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
      btnStopComplaints.onclick = null; // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫

      // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
      logsContainer.innerHTML = "";
    };
  });

  // –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  btnDownloadResults.addEventListener("click", () => {
    if (!currentData) {
      alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è");
      return;
    }

    const jsonStr = JSON.stringify(currentData, null, 2);
    const blob = new Blob([jsonStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `wb-complaints-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    addLog("success", "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞—á–∞–Ω—ã");
  });

  // –ù–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
  btnNewComplaints.addEventListener("click", () => {
    currentData = null;
    complaintsResults.classList.add("hidden");
    btnStartComplaints.classList.remove("hidden");
    logsContainer.innerHTML = "";
    addLog("info", "üîÑ –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ");
  });

  // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
  document.getElementById("btn-clear-logs")?.addEventListener("click", () => {
    logsContainer.innerHTML = "";
  });

  // –°–∫–∞—á–∞—Ç—å –ª–æ–≥–∏
  document.getElementById("btn-download-logs")?.addEventListener("click", downloadLogs);
  document.getElementById("btn-download-logs-final")?.addEventListener("click", downloadLogs);

  function downloadLogs() {
    const logs = Array.from(logsContainer.children).map(entry => entry.textContent);
    const text = logs.join("\n");
    const blob = new Blob([text], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `wb-complaints-logs-${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç API
  document.getElementById("btn-download-api-report")?.addEventListener("click", async () => {
    try {
      addLog("info", "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ API...");

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ—Ç—á–µ—Ç —É background.js
      const response = await chrome.runtime.sendMessage({ type: "getAPIReport" });

      if (!response.success) {
        addLog("error", "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç API");
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç API");
        return;
      }

      const report = response.report;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
      if (report.analysis.duplicatesCount > 0) {
        addLog("warn", `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –ù–∞–π–¥–µ–Ω–æ ${report.analysis.duplicatesCount} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤!`);
        report.analysis.duplicates.forEach(dup => {
          addLog("warn", `‚ö†Ô∏è ID ${dup.reviewId}: –±–∞—Ç—á #${dup.firstSeenInBatch + 1} ‚Üí –±–∞—Ç—á #${dup.appearedAgainInBatch + 1}`);
        });
      } else {
        addLog("success", "‚úÖ –î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ");
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç
      const jsonStr = JSON.stringify(report, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `wb-api-report-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      addLog("success", `‚úÖ –û—Ç—á–µ—Ç API —Å–∫–∞—á–∞–Ω (–±–∞—Ç—á–µ–π: ${report.sessionInfo.totalBatches}, –ø–æ–ª—É—á–µ–Ω–æ: ${report.sessionInfo.totalReceived}, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${report.sessionInfo.totalSent})`);
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞:", error);
      addLog("error", `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
      alert("‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞: " + error.message);
    }
  });

  // ========================================================================
  // GOOGLE SHEETS –û–¢–ü–†–ê–í–ö–ê –û–¢–ß–Å–¢–û–í
  // ========================================================================

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≥–æ –±–∞—Ç—á–∞ –≤ Google Sheets
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { success: true }, { disabled: true }, –∏–ª–∏ { error: "..." }
  async function sendBatchToSheets(batchNumber, stats, status = "completed", complaints = []) {
    try {
      const storeName = storeSelect.options[storeSelect.selectedIndex]?.text || "Unknown";
      const storeId = previewData?.selectedStore || "";
      const batchId = `batch_${Date.now()}_${batchNumber}`;

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º logBatch –µ—Å–ª–∏ –µ—Å—Ç—å –∂–∞–ª–æ–±—ã, –∏–Ω–∞—á–µ logSession
      const hasComplaints = complaints && complaints.length > 0;

      const payload = {
        action: hasComplaints ? "logBatch" : "logSession",
        token: "", // –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ background.js
        batchId: batchId,
        storeId: storeId,
        storeName: storeName,
        session: {
          batchId: batchId,
          batchNumber: batchNumber + 1,
          storeId: storeId,
          storeName: storeName,
          total: stats.processed || 0,
          sent: stats.sent || 0,
          skipped: stats.skipped || 0,
          errors: stats.errors || 0,
          duration: stats.duration || 0,
          status: status,
          startTime: stats.startTime || new Date().toISOString(),
          starsFilter: previewData?.checkedStars || [],
          articlesFilter: previewData?.articlesArray || []
        }
      };

      // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –∂–∞–ª–æ–±–∞—Ö –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      if (hasComplaints) {
        payload.complaints = complaints.map(c => ({
          timestamp: c.timestamp || new Date().toISOString(),
          article: c.article || c.productId || "",
          reviewId: c.reviewId || c.id || "",
          rating: c.rating || "",
          reasonId: c.reasonId || "",
          reasonName: c.reasonName || "",
          complaintText: c.complaintText || "",
          status: c.status || "sent",
          error: c.error || "",
          duration: c.duration || "",
          reviewText: c.reviewText || "",
          author: c.author || "",
          reviewDate: c.reviewDate || ""
        }));

        addLog("info", `üìù –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${complaints.length} –∂–∞–ª–æ–± –≤ Sheets...`);
      }

      const responseData = await chrome.runtime.sendMessage({
        type: "sendToGoogleSheets",
        payload: payload
      });

      if (responseData?.success) {
        if (hasComplaints) {
          addLog("info", `üìä –ü–∞–∫–µ—Ç #${batchNumber + 1}: ${complaints.length} –∂–∞–ª–æ–± –∑–∞–ø–∏—Å–∞–Ω–æ –≤ Sheets`);
        } else {
          addLog("info", `üìä –ü–∞–∫–µ—Ç #${batchNumber + 1} (${status}) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Sheets`);
        }
        return { success: true };
      } else if (responseData?.reason === "disabled") {
        // Google Sheets –æ—Ç–∫–ª—é—á–µ–Ω—ã - —Ç–∏—Ö–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        return { disabled: true };
      } else {
        addLog("warn", `‚ö†Ô∏è Sheets –æ—à–∏–±–∫–∞: ${responseData?.error || "Unknown"}`);
        return { error: responseData?.error || "Unknown" };
      }
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–∞—Ç—á–∞ –≤ Sheets:", error);
      addLog("error", `‚ùå Sheets: ${error.message}`);
      return { error: error.message };
    }
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –≤ Google Sheets (—á–µ—Ä–µ–∑ background script –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS)
  async function sendToGoogleSheets(sessionData, complaints = []) {
    try {
      addLog("info", "üìä –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á—ë—Ç –≤ Google Sheets...");

      const batchId = `batch_${Date.now()}`;
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä—ë–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
      const storeName = storeSelect.options[storeSelect.selectedIndex]?.text || "Unknown";
      const storeId = previewData?.selectedStore || sessionData.storeId || "";

      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      const payload = {
        action: "logBatch",
        batchId: batchId,
        storeId: storeId,
        storeName: storeName,
        session: {
          batchId: batchId,
          storeId: storeId,
          storeName: storeName,
          total: sessionData.processed || 0,
          sent: sessionData.sent || 0,
          skipped: sessionData.skipped || 0,
          errors: sessionData.errors || 0,
          duration: sessionData.duration || 0,
          status: "completed",
          startTime: sessionData.startTime || new Date().toISOString(),
          starsFilter: previewData?.checkedStars || [],
          articlesFilter: previewData?.articlesArray || []
        },
        complaints: complaints.map(c => ({
          timestamp: new Date().toISOString(),
          article: c.productId || c.article || "",
          reviewId: c.id || c.reviewId || "",
          rating: c.rating || "",
          reasonId: c.reasonId || "",
          reasonName: c.reasonName || "",
          status: c.status || "sent",
          error: c.error || "",
          duration: c.duration || ""
        })),
        articleStats: sessionData.articleStats || {}
      };

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ background script (–æ–±—Ö–æ–¥ CORS)
      const responseData = await chrome.runtime.sendMessage({
        type: "sendToGoogleSheets",
        payload: payload
      });

      if (responseData?.success) {
        addLog("success", `‚úÖ –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Google Sheets`);
        return { success: true, batchId: batchId };
      } else if (responseData?.reason === "disabled") {
        console.log("üìä Google Sheets –æ—Ç–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö");
        return { success: false, reason: "disabled" };
      } else {
        addLog("error", `‚ùå –û—à–∏–±–∫–∞ Google Sheets: ${responseData?.error || "Unknown"}`);
        return { success: false, error: responseData?.error };
      }
    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google Sheets:", error);
      addLog("error", `‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Sheets: ${error.message}`);
      return { success: false, error: error.message };
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞—Ç—á–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
  function addBatchToHistory(batchNumber, stats) {
    batchesHistory.push({
      batch: batchNumber,
      processed: stats.processed,
      sent: stats.sent,
      skipped: stats.skipped,
      errors: stats.errors,
      timestamp: new Date().toLocaleTimeString('ru-RU')
    });

    updateBatchesDisplay();
    updateTotalStats();
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞—Ç—á–µ–π
  function updateBatchesDisplay() {
    const batchesList = document.getElementById("batches-list");
    if (!batchesList) return;

    const html = batchesHistory.map((b, idx) => {
      const isLast = idx === batchesHistory.length - 1;
      const status = isLast && isProcessing ? " <span style='color: #3b82f6;'>[–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...]</span>" : "";

      return `
        <div style="padding: 4px 8px; ${isLast ? 'background: #eff6ff; border-left: 3px solid #3b82f6; border-radius: 4px;' : ''}">
          ‚Ä¢ –ü–∞–∫–µ—Ç #${b.batch + 1}: ${b.processed} ‚ûú ‚úÖ${b.sent} ‚è≠Ô∏è${b.skipped} ‚ùå${b.errors}${status}
        </div>
      `;
    }).join('');

    batchesList.innerHTML = html || '<div style="color: #9ca3af; font-style: italic;">–ü–∞–∫–µ—Ç—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...</div>';
    document.getElementById("batches-count").textContent = batchesHistory.length;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  function updateTotalStats() {
    document.getElementById("c-total-processed").textContent = totalProcessedGlobal;
    document.getElementById("c-total-sent").textContent = totalSentGlobal;

    // –ü–æ–¥—Å—á–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∏ –æ—à–∏–±–æ–∫
    const totalSkipped = batchesHistory.reduce((sum, b) => sum + b.skipped, 0);
    const totalErrors = batchesHistory.reduce((sum, b) => sum + b.errors, 0);

    document.getElementById("c-total-skipped").textContent = totalSkipped;
    document.getElementById("c-total-errors").textContent = totalErrors;
  }

  // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç–µ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
  chrome.runtime.onMessage.addListener(async (message) => {
    if (message.type === "complaintLog") {
      addLog(message.level || "info", message.message);
    }

    if (message.type === "complaintProgress") {
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ–∫—É—â–µ–≥–æ –±–∞—Ç—á–∞ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
      const progressProcessed = document.getElementById("c-progress-processed");
      const progressSent = document.getElementById("c-progress-sent");
      const progressSkipped = document.getElementById("c-progress-skipped");
      const progressErrors = document.getElementById("c-progress-errors");

      if (progressProcessed) progressProcessed.textContent = message.processed || 0;
      if (progressSent) progressSent.textContent = message.sent || 0;
      if (progressSkipped) progressSkipped.textContent = message.skipped || 0;
      if (progressErrors) progressErrors.textContent = message.errors || 0;

      const progressFill = document.getElementById("c-progress-fill");
      if (progressFill && message.total > 0) {
        const percent = ((message.processed || 0) / message.total) * 100;
        progressFill.style.width = percent + "%";
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ "–í–°–ï–ì–û" –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ)
      const totalProcessedEl = document.getElementById("c-total-processed");
      const totalSentEl = document.getElementById("c-total-sent");
      const totalSkippedEl = document.getElementById("c-total-skipped");
      const totalErrorsEl = document.getElementById("c-total-errors");

      if (totalProcessedEl && totalSentEl && totalSkippedEl && totalErrorsEl) {
        // –°—É–º–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –±–∞—Ç—á–µ–π + —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
        const completedProcessed = batchesHistory.reduce((sum, b) => sum + b.processed, 0);
        const completedSent = batchesHistory.reduce((sum, b) => sum + b.sent, 0);
        const completedSkipped = batchesHistory.reduce((sum, b) => sum + b.skipped, 0);
        const completedErrors = batchesHistory.reduce((sum, b) => sum + b.errors, 0);

        totalProcessedEl.textContent = completedProcessed + (message.processed || 0);
        totalSentEl.textContent = completedSent + (message.sent || 0);
        totalSkippedEl.textContent = completedSkipped + (message.skipped || 0);
        totalErrorsEl.textContent = completedErrors + (message.errors || 0);
      }
    }

    if (message.type === "complaintComplete") {
      currentData = message.data;

      // –î–æ–±–∞–≤–ª—è–µ–º –±–∞—Ç—á –≤ –∏—Å—Ç–æ—Ä–∏—é
      addBatchToHistory(currentBatch, message.data.stats);

      // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
      totalProcessedGlobal += message.data.stats.processed;
      totalSentGlobal += message.data.stats.sent;

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—É—Å—Ç—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ
      consecutiveEmptyBatches = 0;

      addLog("success", `‚úÖ –ü–∞–∫–µ—Ç #${currentBatch + 1} –∑–∞–≤–µ—Ä—à–µ–Ω! –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${message.data.stats.sent}, –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${message.data.stats.skipped}, –û—à–∏–±–æ–∫: ${message.data.stats.errors}`);
      addLog("info", `üìä –í—Å–µ–≥–æ –∑–∞ —Å–µ—Å—Å–∏—é: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${totalProcessedGlobal}, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${totalSentGlobal}`);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∞ –≤ Google Sheets (–≤–∫–ª—é—á–∞—è –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∂–∞–ª–æ–±—ã)
      await sendBatchToSheets(currentBatch, message.data.stats, "completed", message.data.complaints || []);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –ø–æ—Ä—Ü–∏—é?
      // –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ >= BATCH_SIZE –∂–∞–ª–æ–± (–ø–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç) - –∑–Ω–∞—á–∏—Ç –≤–æ–∑–º–æ–∂–Ω–æ –µ—Å—Ç—å –µ—â–µ
      if (message.data.stats.processed >= BATCH_SIZE && isProcessing) {
        currentBatch++;
        addLog("info", `üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø–∞–∫–µ—Ç #${currentBatch + 1}...`);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–ª–µ–¥—É—é—â–µ–π –ø–æ—Ä—Ü–∏–∏
        loadNextBatch();
      } else {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        addLog("success", `üéâ –í–°–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê! –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${totalSentGlobal} –∂–∞–ª–æ–±`);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á—ë—Ç –≤ Google Sheets
        const sheetsResult = await sendToGoogleSheets({
          processed: totalProcessedGlobal,
          sent: totalSentGlobal,
          skipped: message.data.stats.skipped,
          errors: message.data.stats.errors,
          duration: message.data.stats.duration,
          startTime: message.data.stats.startTime,
          articleStats: message.data.articleStats
        });

        if (sheetsResult.success) {
          addLog("success", `üìä –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ Google Sheets`);
        }

        complaintsProgress.classList.add("hidden");
        complaintsResults.classList.remove("hidden");

        document.getElementById("c-result-processed").textContent = totalProcessedGlobal;
        document.getElementById("c-result-sent").textContent = totalSentGlobal;
        document.getElementById("c-result-skipped").textContent = message.data.stats.skipped;
        document.getElementById("c-result-errors").textContent = message.data.stats.errors;
        document.getElementById("c-result-duration").textContent = message.data.stats.duration + "—Å";
        document.getElementById("c-result-start-time").textContent = message.data.stats.startTime;
        document.getElementById("c-result-end-time").textContent = message.data.stats.endTime;

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º
        if (message.data.articleStats) {
          const articleStatsDiv = document.getElementById("c-article-stats");
          const totalArticles = Object.keys(message.data.articleStats).length;
          const articlesWithComplaints = Object.values(message.data.articleStats).filter(count => count > 0).length;

          articleStatsDiv.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 8px;">
              üìä –ù–∞–π–¥–µ–Ω–æ ${totalSentGlobal} –∂–∞–ª–æ–± –Ω–∞ ${articlesWithComplaints} –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –∏–∑ ${totalArticles}
            </div>
            ${Object.entries(message.data.articleStats)
              .map(([article, count]) =>
                `<div style="padding: 4px 0; border-bottom: 1px solid #e0e7ff;">
                  üì¶ <strong>${article}</strong>: ${count} ${count === 1 ? '–∂–∞–ª–æ–±–∞' : count < 5 ? '–∂–∞–ª–æ–±—ã' : '–∂–∞–ª–æ–±'}
                </div>`
              )
              .join('')}
          `;
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (message.data.ratingStats) {
          const ratingStatsDiv = document.getElementById("c-rating-stats");
          ratingStatsDiv.innerHTML = Object.entries(message.data.ratingStats)
            .map(([rating, count]) => `<div>‚≠ê ${rating}: ${count} –∂–∞–ª–æ–±</div>`)
            .join("");
        }

        isProcessing = false;
      }
    }

    if (message.type === "complaintError") {
      alert("‚ùå –û—à–∏–±–∫–∞: " + message.error);
      complaintsProgress.classList.add("hidden");
      btnStartComplaints.classList.remove("hidden");
      addLog("error", `‚ùå –û—à–∏–±–∫–∞: ${message.error}`);
    }
  });

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
  function showPreviewStats(filteredComplaints, articleStats, isFilterByArticles, checkedStars) {
    // –ü–æ–¥—Å—á–µ—Ç –ø–æ –∑–≤–µ–∑–¥–∞–º
    const starStats = {};
    checkedStars.forEach(star => starStats[star] = 0);

    filteredComplaints.forEach(c => {
      if (starStats[c.rating] !== undefined) {
        starStats[c.rating]++;
      }
    });

    const totalArticles = Object.keys(articleStats).length;

    let html = `
      <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
        <div style="font-size: 16px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">
          ‚úÖ –í—Å–µ–≥–æ –∂–∞–ª–æ–±: ${filteredComplaints.length}
        </div>
        <div style="font-size: 14px; color: #475569;">
          üì¶ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞—Ä—Ç–∏–∫—É–ª–æ–≤: ${totalArticles}
        </div>
      </div>
    `;

    if (isFilterByArticles) {
      html += `
        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 8px;">üîç –§–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω</div>
          <div style="font-size: 13px; color: #64748b;">
            –ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∂–∞–ª–æ–±—ã –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –∞—Ä—Ç–∏–∫—É–ª—ã
          </div>
        </div>
      `;
    } else {
      html += `
        <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 1px solid #fbbf24;">
          <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">‚ö†Ô∏è –§–∏–ª—å—Ç—Ä –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω</div>
          <div style="font-size: 13px; color: #78350f;">
            –ë—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –í–°–ï –∂–∞–ª–æ–±—ã –∏–∑ API
          </div>
        </div>
      `;
    }

    // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∑–≤–µ–∑–¥–∞–º
    html += `
      <div style="background: white; padding: 12px; border-radius: 6px;">
        <div style="font-weight: 600; margin-bottom: 8px;">‚≠ê –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∑–≤–µ–∑–¥–∞–º:</div>
        <div style="display: flex; gap: 16px; font-size: 14px;">
          ${Object.entries(starStats).map(([star, count]) =>
            `<div>${'‚≠ê'.repeat(star)}: <strong>${count}</strong></div>`
          ).join('')}
        </div>
      </div>
    `;

    // –¢–æ–ø –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –° –í–´–ü–ê–î–ê–Æ–©–ò–ú–ò –°–ü–ò–°–ö–ê–ú–ò
    if (totalArticles > 0) {
      const topArticles = Object.entries(articleStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-10

      html += `
        <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 12px;">
          <div style="font-weight: 600; margin-bottom: 12px;">üìä –î–µ—Ç–∞–ª–∏ –∂–∞–ª–æ–± –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º (—Ç–æ–ø-10):</div>
          <div style="font-size: 13px;">
            ${topArticles.map(([article, count]) => {
              // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∂–∞–ª–æ–±—ã –¥–ª—è —ç—Ç–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞
              const articleComplaints = filteredComplaints.filter(c => c.productId === article);

              return `
                <details style="margin-bottom: 8px; padding: 8px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                  <summary style="cursor: pointer; font-weight: 600; padding: 4px 0; user-select: none;">
                    üì¶ <code style="background: #e0e7ff; padding: 2px 6px; border-radius: 3px; color: #3730a3;">${article}</code>:
                    ${count} ${count === 1 ? '–∂–∞–ª–æ–±–∞' : count < 5 ? '–∂–∞–ª–æ–±—ã' : '–∂–∞–ª–æ–±'}
                    <span style="color: #64748b; font-weight: normal; margin-left: 8px;">‚ñº –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—Å—Ç—ã</span>
                  </summary>
                  <div style="margin-top: 12px; padding-left: 8px; border-left: 3px solid #3b82f6;">
                    ${articleComplaints.map((complaint, idx) => {
                      // –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç –∂–∞–ª–æ–±—ã
                      let parsedText = '';
                      let reasonName = '';
                      let rating = complaint.rating || '?';

                      try {
                        // ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ Backend API v2.0
                        let parsed;
                        if (typeof complaint.complaintText === 'object' && complaint.complaintText !== null) {
                          parsed = complaint.complaintText; // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç - —É–∂–µ –æ–±—ä–µ–∫—Ç
                        } else {
                          // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - –ø–∞—Ä—Å–∏–º –∏–∑ markdown-–æ–±—ë—Ä–Ω—É—Ç–æ–π JSON-—Å—Ç—Ä–æ–∫–∏
                          const rawJson = complaint.complaintText.replace(/```json|```/g, "").trim();
                          parsed = JSON.parse(rawJson);
                        }

                        reasonName = parsed.reasonName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

                        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–∞—Ç—ã –∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
                        const now = new Date();
                        const day = String(now.getDate()).padStart(2, "0");
                        const month = String(now.getMonth() + 1).padStart(2, "0");
                        const prefix = "–ñ–∞–ª–æ–±–∞ –æ—Ç: " + day + "." + month + "\\n\\n";

                        parsedText = prefix + (parsed.complaintText || '–¢–µ–∫—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
                      } catch (err) {
                        parsedText = '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞ –∂–∞–ª–æ–±—ã';
                        reasonName = '–û—à–∏–±–∫–∞';
                      }

                      return '<div style="margin-bottom: 12px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #cbd5e1;">' +
                          '<div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">' +
                            '–ñ–∞–ª–æ–±–∞ #' + (idx + 1) +
                            '<span style="color: #64748b; font-weight: normal;">' +
                              ' | ‚≠ê ' + rating +
                              ' | üè∑Ô∏è ' + reasonName +
                              ' | ID: ' + complaint.id +
                            '</span>' +
                          '</div>' +
                          '<div style="background: #f1f5f9; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; color: #334155; line-height: 1.5;">' +
                            parsedText.replace(/</g, '&lt;').replace(/>/g, '&gt;') +
                          '</div>' +
                        '</div>';
                    }).join('')}
                  </div>
                </details>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    apiStatsContent.innerHTML = html;
  }

  // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  btnConfirmStart.addEventListener("click", async () => {
    if (!previewData) {
      alert("‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
      return;
    }

    try {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
      currentBatch = 0;
      totalProcessedGlobal = 0;
      totalSentGlobal = 0;
      consecutiveEmptyBatches = 0;
      batchesHistory = []; // –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –±–∞—Ç—á–µ–π

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      updateBatchesDisplay();
      updateTotalStats();

      // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã –ü–ï–†–ï–î –æ—Ç–ø—Ä–∞–≤–∫–æ–π
      addLog("info", "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å content scripts –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º...");
      const scriptsLoadedSuccessfully = await ensureScriptsLoaded(previewData.wbTab);

      if (!scriptsLoadedSuccessfully) {
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É WB.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n1. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–∑—ã–≤–æ–≤\n2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ\n3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞");
        addLog("error", "‚ùå –ü—Ä–µ—Ä—ã–≤–∞–µ–º –∑–∞–ø—É—Å–∫ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤");
        return;
      }

      addLog("success", `üì§ –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å ${previewData.filteredComplaints.length} –∂–∞–ª–æ–± (–ø–∞–∫–µ—Ç #1)`);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ ID –∂–∞–ª–æ–± (–Ω–µ –≤–µ—Å—å –æ–±—ä–µ–∫—Ç!) –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–∏–º–∏—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
      const complaintIds = previewData.filteredComplaints.map(c => ({
        id: c.id,
        productId: c.productId,
        rating: c.rating,
        reviewDate: c.reviewDate, // –î–û–ë–ê–í–õ–ï–ù–û 2026-01-28: –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–µ–∑ ID
        complaintText: c.complaintText,
        reasonId: null,
        reasonName: null
      }));

      addLog("info", `üì¶ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${complaintIds.length} –∑–∞–ø–∏—Å–µ–π –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É (–ø–∞–∫–µ—Ç #1)`);

      // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º sendMessage –≤ try-catch –¥–ª—è –ª—É—á—à–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
      try {
        await chrome.tabs.sendMessage(previewData.wbTab.id, {
          type: "processComplaintsFromAPI",
          complaints: complaintIds, // –¢–æ–ª—å–∫–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          storeId: previewData.selectedStore,
          stars: previewData.checkedStars,
          articles: previewData.articlesArray,
          articleStats: previewData.articleStats,
        });
        addLog("success", "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ content script");
      } catch (sendError) {
        addLog("error", `‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ${sendError.message}`);
        alert(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É WB.\n\n–û—à–∏–±–∫–∞: ${sendError.message}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–∑—ã–≤–æ–≤.`);
        return;
      }

      // –°–∫—Ä—ã–≤–∞–µ–º preview, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      apiStatsPreview.classList.add("hidden");
      complaintsProgress.classList.remove("hidden");
      complaintsResults.classList.add("hidden");
      isProcessing = true;

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞
      const startTime = new Date().toLocaleTimeString('ru-RU');
      document.getElementById("c-progress-start-time").textContent = startTime;
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:", error);
      alert("‚ùå –û—à–∏–±–∫–∞: " + error.message);
      addLog("error", `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
    }
  });

  // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
  btnCancelPreview.addEventListener("click", () => {
    previewData = null;
    apiStatsPreview.classList.add("hidden");
    btnStartComplaints.classList.remove("hidden");
    addLog("info", "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞");
  });

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–∞–∫–µ—Ç–∞ –∂–∞–ª–æ–±
  async function loadNextBatch() {
    if (!previewData) {
      addLog("error", "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–∞–∫–µ—Ç–∞");
      return;
    }

    try {
      const skip = currentBatch * BATCH_SIZE; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ
      addLog("info", `üì° –ó–∞–ø—Ä–æ—Å –∫ API: skip=${skip}, take=${BATCH_SIZE}`);

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –ø–æ—Ä—Ü–∏—é –∏–∑ API
      const apiResponse = await chrome.runtime.sendMessage({
        type: "getComplaints",
        storeId: previewData.selectedStore,
        skip: skip,
        take: BATCH_SIZE,
      });

      if (apiResponse.error) {
        addLog("error", `‚ùå –û—à–∏–±–∫–∞ API: ${apiResponse.error}`);
        isProcessing = false;
        return;
      }

      if (!apiResponse.data || !Array.isArray(apiResponse.data)) {
        addLog("error", `‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç API`);
        isProcessing = false;
        return;
      }

      const allComplaints = apiResponse.data;
      console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allComplaints.length} –∂–∞–ª–æ–± (–ø–∞–∫–µ—Ç #${currentBatch + 1})`);
      addLog("success", `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allComplaints.length} –∂–∞–ª–æ–± –∏–∑ API (–ø–∞–∫–µ—Ç #${currentBatch + 1})`);

      // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ 0 –∂–∞–ª–æ–± - –∑–Ω–∞—á–∏—Ç –±–æ–ª—å—à–µ –Ω–µ—Ç
      if (allComplaints.length === 0) {
        addLog("success", `üéâ –í—Å–µ –∂–∞–ª–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã! –ë–æ–ª—å—à–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ API.`);
        addLog("info", `üìä –ò—Ç–æ–≥–æ –∑–∞ —Å–µ—Å—Å–∏—é: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${totalProcessedGlobal}, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${totalSentGlobal}`);
        isProcessing = false;
        complaintsProgress.classList.add("hidden");
        complaintsResults.classList.remove("hidden");
        return;
      }

      // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –º–µ–Ω—å—à–µ —á–µ–º BATCH_SIZE - —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–∞—Ç—á
      if (allComplaints.length < BATCH_SIZE) {
        addLog("info", `‚ÑπÔ∏è –ü–æ–ª—É—á–µ–Ω –Ω–µ–ø–æ–ª–Ω—ã–π –±–∞—Ç—á (${allComplaints.length}/${BATCH_SIZE}) - –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ—Ä—Ü–∏—è`);
      }

      // ========== –§–ò–õ–¨–¢–† –ü–û –î–õ–ò–ù–ï –¢–ï–ö–°–¢–ê ==========
      const MAX_TEXT_LENGTH = 1000;
      const PREFIX_LENGTH = 20; // "–ñ–∞–ª–æ–±–∞ –æ—Ç: DD.MM\n\n"
      const MAX_COMPLAINT_TEXT = MAX_TEXT_LENGTH - PREFIX_LENGTH; // 980

      const filterResults = {
        total: allComplaints.length,
        valid: 0,
        tooLong: 0,
        parseError: 0,
        longTexts: []
      };

      const allComplaintsFiltered = allComplaints.filter(complaint => {
        try {
          // ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ Backend API v2.0
          // Backend —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç complaintText –∫–∞–∫ –æ–±—ä–µ–∫—Ç, –∞ –Ω–µ JSON-—Å—Ç—Ä–æ–∫—É
          let parsed;
          if (typeof complaint.complaintText === 'object' && complaint.complaintText !== null) {
            parsed = complaint.complaintText; // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç - —É–∂–µ –æ–±—ä–µ–∫—Ç
          } else {
            // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - –ø–∞—Ä—Å–∏–º –∏–∑ markdown-–æ–±—ë—Ä–Ω—É—Ç–æ–π JSON-—Å—Ç—Ä–æ–∫–∏
            const rawJson = complaint.complaintText.replace(/```json|```/g, "").trim();
            parsed = JSON.parse(rawJson);
          }
          const textLength = (parsed.complaintText || "").length;

          if (textLength > MAX_COMPLAINT_TEXT) {
            filterResults.tooLong++;
            filterResults.longTexts.push({
              productId: complaint.productId,
              id: complaint.id,
              length: textLength
            });
            return false;
          }

          filterResults.valid++;
          return true;
        } catch (err) {
          filterResults.parseError++;
          return false;
        }
      });

      // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      addLog("info", `üìè –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–ª–∏–Ω–µ (–º–∞–∫—Å ${MAX_COMPLAINT_TEXT} —Å–∏–º–≤–æ–ª–æ–≤):`);
      addLog("info", `  ‚úÖ –í–∞–ª–∏–¥–Ω—ã—Ö: ${filterResults.valid}`);
      if (filterResults.tooLong > 0) {
        addLog("warn", `  ‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã—Ö: ${filterResults.tooLong}`);
        const top3 = filterResults.longTexts.sort((a, b) => b.length - a.length).slice(0, 3);
        top3.forEach(item => {
          addLog("warn", `    üì¶ –ê—Ä—Ç ${item.productId}, ID ${item.id}: ${item.length} —Å–∏–º–≤–æ–ª–æ–≤`);
        });
      }
      if (filterResults.parseError > 0) {
        addLog("error", `  ‚ùå –û—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${filterResults.parseError}`);
      }

      // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∏ –∑–≤–µ–∑–¥–∞–º
      let filteredComplaints;

      if (previewData.isFilterByArticles) {
        filteredComplaints = allComplaintsFiltered.filter(complaint =>
          previewData.articlesArray.includes(complaint.productId) &&
          previewData.checkedStars.includes(complaint.rating)
        );
      } else {
        filteredComplaints = allComplaintsFiltered.filter(complaint =>
          previewData.checkedStars.includes(complaint.rating)
        );
      }

      addLog("info", `üîç –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: ${filteredComplaints.length} –∂–∞–ª–æ–±`);

      // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å - –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø–∞–∫–µ—Ç
      if (filteredComplaints.length === 0) {
        consecutiveEmptyBatches++;
        addLog("warn", `‚ö†Ô∏è –í –ø–∞–∫–µ—Ç–µ #${currentBatch + 1} –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∂–∞–ª–æ–±, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º... (${consecutiveEmptyBatches}/${MAX_EMPTY_BATCHES})`);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –ø—É—Å—Ç—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
        if (consecutiveEmptyBatches >= MAX_EMPTY_BATCHES) {
          addLog("error", `‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø—É—Å—Ç—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ (${MAX_EMPTY_BATCHES}). –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É.`);
          addLog("info", `üí° –í–æ–∑–º–æ–∂–Ω–æ, –≤—Å–µ –∂–∞–ª–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–µ`);
          isProcessing = false;
          complaintsProgress.classList.add("hidden");
          complaintsResults.classList.remove("hidden");
          return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—Ä–æ—Å–æ–º (–∑–∞—â–∏—Ç–∞ –æ—Ç rate limit)
        currentBatch++;
        addLog("info", `‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—Ä–æ—Å–æ–º...`);
        setTimeout(() => loadNextBatch(), 2000);
        return;
      }

      // –ï—Å–ª–∏ –µ—Å—Ç—å –∂–∞–ª–æ–±—ã - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—É—Å—Ç—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
      consecutiveEmptyBatches = 0;

      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      const complaintIds = filteredComplaints.map(c => ({
        id: c.id,
        productId: c.productId,
        rating: c.rating,
        reviewDate: c.reviewDate, // –î–û–ë–ê–í–õ–ï–ù–û 2026-01-28: –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–µ–∑ ID
        complaintText: c.complaintText,
        reasonId: null,
        reasonName: null
      }));

      addLog("info", `üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${complaintIds.length} –∂–∞–ª–æ–± –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É (–ø–∞–∫–µ—Ç #${currentBatch + 1})`);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ content script –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
      chrome.tabs.sendMessage(previewData.wbTab.id, {
        type: "processComplaintsFromAPI",
        complaints: complaintIds,
        storeId: previewData.selectedStore,
        stars: previewData.checkedStars,
        articles: previewData.articlesArray,
        articleStats: previewData.articleStats,
      });

    } catch (error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–∞–∫–µ—Ç–∞:", error);
      addLog("error", `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
      isProcessing = false;
    }
  }

  addLog("info", "‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–∞—á–∏ –∂–∞–ª–æ–± –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ");
});
