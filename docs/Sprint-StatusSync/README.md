# Sprint: Status Sync

> **Синхронизация статусов отзывов между расширением и Backend**

**Дата создания:** 01.02.2026
**Статус:** РЕАЛИЗОВАНО
**Приоритет:** Высокий (экономия токенов GPT)

---

## Проблема

Backend генерирует жалобы через GPT на **ВСЕ** отзывы из базы, включая те, на которые уже невозможно подать жалобу:

| Статус | Можно подать? | Что происходит сейчас |
|--------|---------------|----------------------|
| Жалоба отклонена | НЕТ | GPT генерирует жалобу впустую |
| Жалоба одобрена | НЕТ | GPT генерирует жалобу впустую |
| Проверяем жалобу | НЕТ | GPT генерирует жалобу впустую |
| Жалоба пересмотрена | НЕТ | GPT генерирует жалобу впустую |
| Нет статуса жалобы | ДА | Корректная работа |

### Статистика потерь

Данные из консольного теста расширения (15 страниц, ~1500 отзывов):

```
Жалоба отклонена: 1382 (~92%)
Жалоба одобрена: 103  (~7%)
Проверяем жалобу: 1   (<1%)
```

**Вывод:** ~80% токенов GPT тратится на генерацию жалоб, которые невозможно подать.

---

## Решение

Расширение при парсинге отзывов отправляет их статусы в Backend:

```
[Расширение] → парсит статусы → POST /api/extension/review-statuses → [Backend]
                                                                           ↓
[Backend] → фильтрует отзывы по статусам → генерирует жалобы ТОЛЬКО на подходящие
```

### Ключевые принципы

1. **Отдельная таблица** - статусы от расширения хранятся в новой таблице `review_statuses_from_extension`, не в основной `reviews`
2. **Минимальный payload** - передаём только необходимые данные
3. **Идемпотентность** - повторная отправка тех же данных не создаёт дубликатов

---

## Что передаёт расширение

```javascript
{
  storeId: "7kKX9WgLvOPiXYIHk6hi",             // ID магазина (наш внутренний)
  parsedAt: "2026-02-01T12:00:00.000Z",        // Время парсинга (UTC)
  reviews: [
    {
      reviewKey: "649502497_1_2026-01-07T20:09",  // Уникальный ключ (без секунд)
      productId: "649502497",                      // Артикул WB (nmId)
      rating: 1,                                   // Рейтинг 1-5
      reviewDate: "2026-01-07T20:09:37.000Z",     // Дата отзыва (ISO 8601)
      statuses: ["Жалоба отклонена", "Выкуп"],    // Массив статусов
      canSubmitComplaint: false                    // Флаг: можно ли подать жалобу
    },
    // ... другие отзывы
  ]
}
```

### Логика определения `canSubmitComplaint`

```javascript
const COMPLAINT_STATUSES = [
  'Жалоба отклонена',
  'Жалоба одобрена',
  'Проверяем жалобу',
  'Жалоба пересмотрена'
];

// Можно подать = НЕТ ни одного статуса жалобы
const canSubmitComplaint = !statuses.some(s => COMPLAINT_STATUSES.includes(s));
```

---

## Документация спринта

| Документ | Описание |
|----------|----------|
| [API-SPEC.md](API-SPEC.md) | Спецификация API endpoint (АКТУАЛЬНО) |
| [EXTENSION-IMPLEMENTATION.md](EXTENSION-IMPLEMENTATION.md) | Что делает расширение |
| [TESTING-PLAN.md](TESTING-PLAN.md) | План тестирования интеграции |

---

## Этапы реализации

### Этап 1: Backend (разработчики Backend) - ГОТОВО
- [x] Создать таблицу `review_statuses_from_extension`
- [x] Реализовать endpoint `POST /api/extension/review-statuses`
- [x] Реализовать endpoint `GET /api/extension/review-statuses` (для тестирования)
- [x] Добавить фильтрацию при выборке отзывов для генерации жалоб ✅ **ГОТОВО (01.02.2026)**
- [x] Автосинхронизация статусов в таблицу `reviews` при POST ✅ **ГОТОВО**
- [x] Блокировка генерации жалоб на отзывы с существующим статусом ✅ **ГОТОВО**
- [x] Блокировка генерации на 5-звёздные отзывы ✅ **ГОТОВО**

### Этап 2: Расширение (ваша команда) - ГОТОВО
- [x] Добавить отправку статусов после парсинга
- [x] Интегрировать в основной воркфлоу подачи жалоб
- [x] См. [INTEGRATION-COMPLETE.md](INTEGRATION-COMPLETE.md)

### Этап 3: Тестирование - ГОТОВО
- [x] Проверить синхронизацию статусов ✅ (17 отзывов синхронизировано: 12 rejected, 5 approved)
- [x] Проверить фильтрацию при генерации ✅ (блокировка работает)
- [ ] Замерить экономию токенов (ожидается ~80%)

---

## Production API

| Параметр | Значение |
|----------|----------|
| **Base URL** | `https://wb-reputation-2.ru` |
| **POST Endpoint** | `POST /api/extension/review-statuses` |
| **GET Endpoint** | `GET /api/extension/review-statuses?storeId=...` |
| **Authorization** | `Bearer <api_token>` |

---

## Ожидаемый результат

| Метрика | До | После |
|---------|-----|-------|
| Генерация жалоб GPT | 100% отзывов | ~20% отзывов |
| Экономия токенов | 0% | ~80% |
| Успешность подачи | Низкая (много отказов) | Высокая |

---

## Контакты

**Расширение:** [текущая команда]
**Backend:** Реализовано, endpoints готовы к использованию
