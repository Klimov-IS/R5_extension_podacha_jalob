# ТЗ: Передача статуса чата в API синхронизации отзывов

> **Для:** Backend-команда
> **От:** Extension-команда
> **Дата:** 2026-02-19
> **Статус:** Задеплоено на прод (extension + backend)
> **Sprint:** 2 — Review-Chat Linking
> **Миграция БД:** `017_add_chat_status_opened.sql`

---

## 1. Цель

Расширение при подаче жалоб **уже парсит статусы отзывов** и отправляет их на бэкенд через `POST /api/extension/review-statuses`. Теперь расширение будет **дополнительно парсить состояние кнопки чата** рядом с каждым отзывом и передавать его в том же запросе.

### Зачем это нужно

1. **Подготовка к Sprint 2 (чат-воркфлоу):** нам нужна информация в БД о том, какие отзывы имеют открытые чаты, какие могут быть открыты, а у каких кабинетов чаты вообще не активированы.
2. **Аналитика покрытия:** менеджеры смогут видеть, сколько отзывов с открытыми чатами по каждому магазину.
3. **Планирование:** понимание, по каким кабинетам стоит подключать чаты с покупателями.
4. **Фильтрация отзывов:** в UI бэкенда (таб "Отзывы") добавить возможность фильтровать по статусу чата.

---

## 2. Контекст: кнопка чата в UI Wildberries

На странице отзывов WB рядом с каждым отзывом есть кнопка "Открыть чат с покупателем". Она имеет **3 состояния**:

| Состояние | Визуал | HTML | Что означает |
|-----------|--------|------|--------------|
| **Прозрачная (disabled)** | Полупрозрачная серая иконка | `<button disabled>` | Функция чатов **не активирована** в кабинете. Новые чаты открыть нельзя |
| **Серая (активная)** | Серая иконка | `<button>` (без disabled) | Чат **можно открыть** (новый чат, ещё не создан) |
| **Чёрная (активная)** | Чёрная иконка | `<button>` (без disabled) | Чат **уже открыт** (переписка уже существует) |

### Важный нюанс

В одном кабинете **могут одновременно** быть:
- Прозрачные кнопки (новые чаты заблокированы)
- Чёрные кнопки (ранее открытые чаты всё ещё доступны)

Это значит, что `chat_not_activated` — это **статус отдельного отзыва**, а не кабинета в целом. Хотя если все кнопки прозрачные — значит кабинет не активирован.

---

## 3. Изменение API

### 3.1 Эндпоинт: `POST /api/extension/review-statuses`

Ничего не меняется в структуре запроса, кроме **добавления нового поля `chatStatus`** в объект каждого отзыва.

### 3.2 Текущий формат (до изменений)

```json
{
  "storeId": "store_abc123",
  "parsedAt": "2026-02-19T12:00:00.000Z",
  "reviews": [
    {
      "reviewKey": "649502497_1_2026-01-07T20:09",
      "productId": "649502497",
      "rating": 1,
      "reviewDate": "2026-01-07T20:09:37.000Z",
      "statuses": ["Жалоба отклонена", "Выкуп"],
      "canSubmitComplaint": false
    }
  ]
}
```

### 3.3 Новый формат (после изменений)

```json
{
  "storeId": "store_abc123",
  "parsedAt": "2026-02-19T12:00:00.000Z",
  "reviews": [
    {
      "reviewKey": "649502497_1_2026-01-07T20:09",
      "productId": "649502497",
      "rating": 1,
      "reviewDate": "2026-01-07T20:09:37.000Z",
      "statuses": ["Жалоба отклонена", "Выкуп"],
      "canSubmitComplaint": false,
      "chatStatus": "chat_opened"
    }
  ]
}
```

### 3.4 Поле `chatStatus` — спецификация

| Свойство | Значение |
|----------|----------|
| Имя поля | `chatStatus` |
| Тип | `string | null` |
| Обязательное | Нет (nullable) |
| Backward-compatible | Да — старые запросы без `chatStatus` должны работать как раньше |

### 3.5 Допустимые значения `chatStatus`

| Значение | Описание | Когда расширение отправляет |
|----------|----------|----------------------------|
| `"chat_not_activated"` | Чаты не активированы | Кнопка чата прозрачная (disabled) |
| `"chat_available"` | Можно открыть новый чат | Кнопка чата серая (активная) |
| `"chat_opened"` | Чат уже открыт | Кнопка чата чёрная (активная) |
| `null` | Нет данных | Кнопка не найдена / ошибка парсинга |

---

## 4. Требования к бэкенду

### 4.1 Хранение

- Добавить **nullable колонку** `chat_status VARCHAR(32)` в таблицу `review_statuses` (или аналог)
- При получении `chatStatus` в запросе — сохранять/обновлять значение
- При отсутствии поля в запросе — оставлять `null` (не перезаписывать)
- При получении `null` — сохранять `null`

### 4.2 Обработка

```
IF chatStatus отсутствует в запросе → не трогать текущее значение в БД
IF chatStatus = null              → записать null
IF chatStatus = "chat_not_activated" | "chat_available" | "chat_opened" → записать значение
IF chatStatus = любое другое      → вернуть 400 Bad Request
```

### 4.3 Валидация

- Допустимые значения: `"chat_not_activated"`, `"chat_available"`, `"chat_opened"`, `null`
- Любое другое строковое значение → ошибка валидации
- Поле необязательное — отсутствие поля НЕ является ошибкой

### 4.4 Маппинг значений (extension → DB)

Бэкенд маппит значения расширения в PostgreSQL ENUM `chat_status_by_review`:

| Extension отправляет | БД хранит (ENUM) |
|---------------------|-------------------|
| `chat_not_activated` | `unavailable` |
| `chat_available` | `available` |
| `chat_opened` | `opened` |
| `null` | `unknown` |

Матчинг отзывов: `store_id + product_id + rating + DATE_TRUNC('minute', review_date)`.

### 4.5 Ответ API

Формат ответа **обновлён** (добавлены поля синхронизации):

```json
{
  "success": true,
  "data": {
    "received": 50,
    "created": 30,
    "updated": 20,
    "errors": 0,
    "synced": 15,
    "chatStatusSynced": 42,
    "syncErrors": 0
  },
  "message": "Статусы успешно синхронизированы"
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `synced` | number | Отзывы, сопоставленные с основной таблицей reviews |
| `chatStatusSynced` | number | Отзывы, у которых обновлён `chat_status_by_review` |
| `syncErrors` | number | Ошибки при синхронизации с основной таблицей |

---

## 5. Требования к UI бэкенда (таб "Отзывы")

### 5.1 Новый фильтр "Статус чата"

Добавить dropdown-фильтр "Статус чата" в таб "Отзывы" по аналогии с существующими фильтрами по статусу жалобы.

Опции:
| Label (в UI) | Значение (в запросе) |
|--------------|----------------------|
| Все | — (без фильтра) |
| Чат: не активирован | `chat_not_activated` |
| Чат: можно открыть | `chat_available` |
| Чат: открыт | `chat_opened` |
| Нет данных | `null` |

### 5.2 Отображение статуса чата в таблице отзывов

В таблице отзывов добавить колонку или бейдж "Чат" с цветовой индикацией:

| chatStatus | Бейдж | Цвет |
|------------|-------|------|
| `chat_not_activated` | Не активирован | Серый |
| `chat_available` | Можно открыть | Синий |
| `chat_opened` | Открыт | Зелёный |
| `null` | — | Без бейджа |

### 5.3 Аналитика (опционально, низкий приоритет)

На дашборде или в карточке магазина — сводка:
- Всего отзывов с данными чата: N
- Чат открыт: N (X%)
- Можно открыть: N (X%)
- Не активирован: N (X%)

---

## 6. Примеры запросов

### 6.1 Смешанные статусы чатов в одном кабинете

```bash
curl -X POST https://rating5.ru/api/extension/review-statuses \
  -H "Authorization: Bearer wbrm_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "storeId": "store_abc123",
    "parsedAt": "2026-02-19T14:30:00.000Z",
    "reviews": [
      {
        "reviewKey": "649502497_1_2026-01-07T20:09",
        "productId": "649502497",
        "rating": 1,
        "reviewDate": "2026-01-07T20:09:37.000Z",
        "statuses": ["Жалоба отклонена"],
        "canSubmitComplaint": false,
        "chatStatus": "chat_opened"
      },
      {
        "reviewKey": "649502497_2_2026-01-08T14:22",
        "productId": "649502497",
        "rating": 2,
        "reviewDate": "2026-01-08T14:22:15.000Z",
        "statuses": ["Виден"],
        "canSubmitComplaint": true,
        "chatStatus": "chat_not_activated"
      },
      {
        "reviewKey": "341213496_3_2026-02-01T09:15",
        "productId": "341213496",
        "rating": 3,
        "reviewDate": "2026-02-01T09:15:00.000Z",
        "statuses": ["Виден"],
        "canSubmitComplaint": true,
        "chatStatus": "chat_available"
      }
    ]
  }'
```

### 6.2 Старый формат (без chatStatus) — должен работать

```bash
curl -X POST https://rating5.ru/api/extension/review-statuses \
  -H "Authorization: Bearer wbrm_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "storeId": "store_abc123",
    "parsedAt": "2026-02-19T14:30:00.000Z",
    "reviews": [
      {
        "reviewKey": "649502497_1_2026-01-07T20:09",
        "productId": "649502497",
        "rating": 1,
        "reviewDate": "2026-01-07T20:09:37.000Z",
        "statuses": ["Жалоба отклонена"],
        "canSubmitComplaint": false
      }
    ]
  }'
```

Ожидаемый результат: 200 OK, `chatStatus` = null в БД.

---

## 7. Миграция БД

### SQL (ориентировочно)

```sql
ALTER TABLE review_statuses
ADD COLUMN chat_status VARCHAR(32) DEFAULT NULL;

-- Индекс для фильтрации
CREATE INDEX idx_review_statuses_chat_status
ON review_statuses(chat_status);

-- Составной индекс для фильтрации по магазину + чат
CREATE INDEX idx_review_statuses_store_chat
ON review_statuses(store_id, chat_status);
```

---

## 8. Оценка трудоёмкости

| Задача | Оценка |
|--------|--------|
| Миграция БД (новая колонка + индексы) | 1ч |
| Обновление API: приём и валидация `chatStatus` | 2ч |
| UI: фильтр в табе "Отзывы" | 2-3ч |
| UI: бейдж/колонка статуса чата | 1-2ч |
| Тестирование | 1-2ч |
| **Итого** | **~8-10ч** |

---

## 9. Timeline

| Событие | Дата | Статус |
|---------|------|--------|
| ТЗ готово | 2026-02-19 | Done |
| Расширение отправляет `chatStatus` | 2026-02-19 | Done |
| Бэкенд принимает `chatStatus` | 2026-02-19 | Done (миграция `017_add_chat_status_opened.sql`) |
| UI фильтр в табе "Отзывы" | 2026-02-19 | Done |

---

## 10. Связанные документы

- [API_CHATS_CONTRACT.md](API_CHATS_CONTRACT.md) — полный контракт API чатов (Sprint 2)
- [EXTENSION_INTEGRATION_GUIDE.md](EXTENSION_INTEGRATION_GUIDE.md) — гайд интеграции
- `docs/BACKEND_API.md` — общая документация API расширения
- `docs/DOM_CONTRACT.md` (секция 2.16) — DOM-контракт кнопки чата
- Инструкция тестирования (бэкенд): `R5 saas-prod/docs/tasks/TASK-20260219-chat-status-sync-testing.md`
